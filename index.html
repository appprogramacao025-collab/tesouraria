<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GONSG - Tesouraria</title>
    <meta name="description" content="Sistema de controle financeiro para o Grupo de Oração Nossa Senhora das Graças">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Base e Utilities */
        :root {
            --primary: hsl(230 50% 50%);
            --primary-dark: hsl(230 50% 40%);
            --text-base: hsl(0 0% 15%);
            --text-muted: hsl(0 0% 40%);
            --bg-light: hsl(0 0% 98%);
            --border: hsl(0 0% 90%);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-light);
            color: var(--text-base);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            width: 100%;
        }
        h1, h2, h3, h4 { font-family: 'Playfair Display', serif; }
        .flex { display: flex; }
        .grid { display: grid; }
        .gap-4 { gap: 1rem; }
        .rounded-lg { border-radius: 8px; }
        .shadow { box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .p-4 { padding: 1rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .text-center { text-align: center; }
        .text-sm { font-size: 0.875rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .font-bold { font-weight: 700; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .bg-white { background-color: white; }
        .border { border: 1px solid var(--border); }
        .text-muted { color: var(--text-muted); }
        .text-green-600 { color: #16a34a; }
        .text-red-600 { color: #dc2626; }
        .text-blue-600 { color: #2563eb; }
        .w-full { width: 100%; }
        .form-group { display: flex; flex-direction: column; gap: 0.25rem; }
        .form-input, .form-select {
            padding: 0.6rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: inherit;
            font-size: 1rem;
            background: white;
            color: var(--text-base);
            transition: border-color 0.2s;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
        }
        .btn {
            padding: 0.75rem 1.5rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn:hover { background-color: var(--primary-dark); }
        .btn:active { transform: translateY(1px); }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Layout Principal */
        .app-layout {
            display: flex;
            min-height: 100vh;
        }
        .main-content {
            flex-grow: 1;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            background: hsl(0 0% 98%);
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: var(--text-base);
            color: white;
            padding: 1.5rem;
            transition: transform 0.3s ease-in-out;
            transform: translateX(0);
            z-index: 10;
        }
        .sidebar.collapsed {
            transform: translateX(-100%);
        }
        .sidebar-brand {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 2rem;
            display: block;
            text-decoration: none;
            color: white;
        }
        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1rem;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            border-radius: 6px;
            transition: background 0.2s, color 0.2s;
        }
        .sidebar-menu a:hover, .sidebar-menu a.active {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        /* Seções de Conteúdo */
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        /* Tabela de Membros */
        .table-responsive {
            overflow-x: auto;
        }
        .member-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            align-items: center;
            padding: 0.75rem 1rem;
            background: var(--bg-light);
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.875rem;
            border: 1px solid var(--border);
        }
        .member-grid.header {
            background: hsl(0 0% 95%);
            font-weight: 600;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .modal.open {
            display: flex;
            opacity: 1;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 450px;
            text-align: center;
        }
        .modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1.5rem;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #22c55e;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .toast-error { background: #ef4444; }

        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes slideOut { from { transform: translateX(0); } to { transform: translateX(100%); } }

        /* Responsividade */
        @media (max-width: 768px) {
            .app-layout { flex-direction: column; }
            .sidebar {
                width: 100%;
                height: 100%;
                position: fixed;
                top: 0;
                left: 0;
                transform: translateX(-100%);
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .main-content {
                padding: 1rem;
            }
            .hamburger-menu {
                display: block;
            }
            .section-header {
                display: flex;
                align-items: center;
                gap: 1rem;
                justify-content: start;
            }
            .member-grid {
                grid-template-columns: 1fr 1fr;
            }
            .member-grid .name { grid-column: 1 / 3; }
            .member-grid .actions { grid-column: 1 / 3; justify-self: center; }
            .monthly-report-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>

    <div class="app-layout">
        <aside id="sidebar" class="sidebar">
            <a href="#" class="sidebar-brand" id="homeLink">GONSG Tesouraria</a>
            <nav class="sidebar-menu">
                <a href="#" data-section="home" class="sidebar-menu-link active"><i class="fas fa-home"></i> Início</a>
                <a href="#" data-section="tesouraria" class="sidebar-menu-link"><i class="fas fa-coins"></i> Tesouraria</a>
                <a href="#" data-section="membros" class="sidebar-menu-link"><i class="fas fa-users"></i> Membros</a>
                <a href="#" data-section="contabilidade" class="sidebar-menu-link"><i class="fas fa-chart-line"></i> Contabilidade</a>
            </nav>
        </aside>

        <main class="main-content">
            <button id="mobileSidebarToggle" class="hamburger-menu hidden">
                <i class="fas fa-bars"></i>
            </button>
            
            <section id="home" class="content-section active">
                <h2 class="text-3xl font-bold mb-4">Visão Geral</h2>
                <div class="grid gap-4 md:grid-cols-4">
                    <div class="p-4 bg-white rounded-lg shadow border text-center">
                        <p class="text-muted text-sm font-semibold mb-2">Saldo Atual</p>
                        <p id="homeSaldoAtual" class="text-2xl font-bold text-green-600">R$ 0,00</p>
                    </div>
                    <div class="p-4 bg-white rounded-lg shadow border text-center">
                        <p class="text-muted text-sm font-semibold mb-2">Total de Membros</p>
                        <p id="homeTotalMembros" class="text-2xl font-bold">0</p>
                    </div>
                    <div class="p-4 bg-white rounded-lg shadow border text-center">
                        <p class="text-muted text-sm font-semibold mb-2">Total de RCC (Geral)</p>
                        <p id="homeTotalRcc" class="text-xl font-bold text-blue-600">R$ 0,00</p>
                    </div>
                    <div class="p-4 bg-white rounded-lg shadow border text-center">
                        <p class="text-muted text-sm font-semibold mb-2">Total de Caixa Extra (Geral)</p>
                        <p id="homeTotalCaixaExtra" class="text-xl font-bold text-blue-600">R$ 0,00</p>
                    </div>
                </div>

                <div class="mt-8 p-4 bg-white rounded-lg shadow border">
                    <h3 class="text-xl font-semibold mb-4">Atividades Recentes</h3>
                    <div id="recentActivities">
                        </div>
                </div>
            </section>

            <section id="tesouraria" class="content-section">
                <h2 class="text-3xl font-bold mb-4">Tesouraria</h2>
                <div class="grid gap-4 md:grid-cols-3">
                    <div class="p-4 bg-white rounded-lg shadow border text-center">
                        <p class="text-muted text-sm font-semibold mb-2">Total de Entradas</p>
                        <p id="totalEntradas" class="text-2xl font-bold text-green-600">R$ 0,00</p>
                    </div>
                    <div class="p-4 bg-white rounded-lg shadow border text-center">
                        <p class="text-muted text-sm font-semibold mb-2">Total de Saídas</p>
                        <p id="totalSaidas" class="text-2xl font-bold text-red-600">R$ 0,00</p>
                    </div>
                    <div class="p-4 bg-white rounded-lg shadow border text-center">
                        <p class="text-muted text-sm font-semibold mb-2">Saldo Atual</p>
                        <p id="saldoAtual" class="text-2xl font-bold">R$ 0,00</p>
                    </div>
                </div>

                <div class="mt-8 p-4 bg-white rounded-lg shadow border">
                    <h3 class="text-xl font-semibold mb-4">Adicionar Transação</h3>
                    <form id="transactionForm" class="grid gap-4">
                        <div class="grid gap-4 md:grid-cols-2">
                            <div class="form-group">
                                <label for="transactionType" class="text-sm font-medium">Tipo</label>
                                <select id="transactionType" class="form-select w-full">
                                    <option value="entrada">Entrada</option>
                                    <option value="saida">Saída</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="transactionAmount" class="text-sm font-medium">Valor (R$)</label>
                                <input type="number" id="transactionAmount" class="form-input w-full" step="0.01" required>
                            </div>
                        </div>
                        <div class="grid gap-4 md:grid-cols-2">
                            <div class="form-group">
                                <label for="transactionDate" class="text-sm font-medium">Data</label>
                                <input type="date" id="transactionDate" class="form-input w-full" required>
                            </div>
                            <div class="form-group">
                                <label for="memberSelect" class="text-sm font-medium">Membro</label>
                                <select id="memberSelect" class="form-select w-full">
                                    <option value="">Nenhum</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="transactionDescription" class="text-sm font-medium">Descrição</label>
                            <textarea id="transactionDescription" class="form-input w-full" rows="2" required></textarea>
                        </div>
                        <button type="submit" class="btn w-full">Adicionar Transação</button>
                    </form>
                </div>

                <div class="mt-8 p-4 bg-white rounded-lg shadow border">
                    <h3 class="text-xl font-semibold mb-4">Histórico de Transações</h3>
                    <div id="transactionHistory">
                        </div>
                </div>
            </section>

            <section id="membros" class="content-section">
                <h2 class="text-3xl font-bold mb-4">Membros</h2>
                <div class="grid gap-4 md:grid-cols-3">
                    <div class="p-4 bg-white rounded-lg shadow border text-center">
                        <p class="text-muted text-sm font-semibold mb-2">Total de Membros</p>
                        <p id="totalMembrosCount" class="text-2xl font-bold">0</p>
                    </div>
                    <div class="p-4 bg-white rounded-lg shadow border text-center">
                        <p class="text-muted text-sm font-semibold mb-2">Total de RCC (mês)</p>
                        <p id="totalRccMes" class="text-xl font-bold text-blue-600">R$ 0,00</p>
                    </div>
                    <div class="p-4 bg-white rounded-lg shadow border text-center">
                        <p class="text-muted text-sm font-semibold mb-2">Total de Caixa Extra (mês)</p>
                        <p id="totalCaixaExtraMes" class="text-xl font-bold text-blue-600">R$ 0,00</p>
                    </div>
                </div>

                <div class="mt-8 p-4 bg-white rounded-lg shadow border">
                    <h3 class="text-xl font-semibold mb-4">Adicionar Novo Membro</h3>
                    <form id="memberForm" class="flex gap-2">
                        <div class="form-group w-full">
                            <label for="memberName" class="text-sm font-medium">Nome do Membro</label>
                            <input type="text" id="memberName" class="form-input w-full" required>
                        </div>
                        <button type="submit" class="btn py-2 px-4 self-end">Adicionar</button>
                    </form>
                </div>

                <div class="mt-8 p-4 bg-white rounded-lg shadow border">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold">Contribuições - <span id="currentMonthYear"></span></h3>
                        <div class="flex gap-2">
                            <select id="membersMonth" class="form-select w-24"></select>
                            <select id="membersYear" class="form-select w-24"></select>
                        </div>
                    </div>
                    <div id="membersTable" class="table-responsive">
                        </div>
                </div>
            </section>

            <section id="contabilidade" class="content-section">
                <h2 class="text-3xl font-bold mb-4">Contabilidade</h2>
                <div class="flex items-center gap-4 mb-8">
                    <h3 class="text-xl font-semibold">Relatório Anual - <span id="reportYear"></span></h3>
                    <select id="contabilidadeYear" class="form-select w-24"></select>
                </div>
                
                <div class="grid gap-4 md:grid-cols-5 mb-8">
                    <div class="p-4 bg-white rounded-lg shadow border text-center">
                        <p class="text-muted text-sm font-semibold mb-2">Entradas</p>
                        <p id="yearlyEntradas" class="text-lg font-bold text-green-600">R$ 0,00</p>
                    </div>
                    <div class="p-4 bg-white rounded-lg shadow border text-center">
                        <p class="text-muted text-sm font-semibold mb-2">RCC</p>
                        <p id="yearlyRcc" class="text-lg font-bold text-blue-600">R$ 0,00</p>
                    </div>
                    <div class="p-4 bg-white rounded-lg shadow border text-center">
                        <p class="text-muted text-sm font-semibold mb-2">Caixa Extra</p>
                        <p id="yearlyCaixaExtra" class="text-lg font-bold text-blue-600">R$ 0,00</p>
                    </div>
                    <div class="p-4 bg-white rounded-lg shadow border text-center">
                        <p class="text-muted text-sm font-semibold mb-2">Saídas</p>
                        <p id="yearlySaidas" class="text-lg font-bold text-red-600">R$ 0,00</p>
                    </div>
                    <div class="p-4 bg-white rounded-lg shadow border text-center">
                        <p class="text-muted text-sm font-semibold mb-2">Saldo</p>
                        <p id="yearlyBalance" class="text-xl font-bold">R$ 0,00</p>
                    </div>
                </div>

                <div id="monthlyReport" class="p-4 bg-white rounded-lg shadow border">
                    </div>
            </section>

        </main>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h4 class="text-xl font-semibold mb-4">Confirmação</h4>
            <p id="confirmText" class="text-muted mb-4"></p>
            <div class="modal-buttons">
                <button id="cancelBtn" class="btn bg-gray-200 text-gray-800">Cancelar</button>
                <button id="confirmBtn" class="btn bg-red-600 text-white">Confirmar</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Importar as bibliotecas do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, doc, deleteDoc, updateDoc, query, where, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Sua configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA4ojfhf2r65ch0KwtCLR4OGdesBBVl7Ok",
            authDomain: "tesouraria-17927.firebaseapp.com",
            projectId: "tesouraria-17927",
            storageBucket: "tesouraria-17927.firebasestorage.app",
            messagingSenderId: "618185390033",
            appId: "1:618185390033:web:53b6f976ca66f48edd52f0"
        };

        // Inicializar Firebase e Firestore
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Funções utilitárias
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }

        function formatDate(timestamp) {
            if (!timestamp || !timestamp.toDate) return '';
            const date = timestamp.toDate();
            return date.toLocaleDateString('pt-BR');
        }

        class DataManager {
            constructor() {
                this.transactionsCollection = collection(db, 'transactions');
                this.membersCollection = collection(db, 'members');
                this.currentTransactions = [];
                this.currentMembers = [];
                this.callbacks = [];
                this.initListeners();
            }

            // Adiciona um listener em tempo real para as coleções
            initListeners() {
                // Listener para transações
                onSnapshot(query(this.transactionsCollection, orderBy('date', 'desc')), (snapshot) => {
                    this.currentTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    this.triggerUpdate();
                });

                // Listener para membros
                onSnapshot(this.membersCollection, (snapshot) => {
                    this.currentMembers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    this.triggerUpdate();
                });
            }

            addCallback(callback) {
                this.callbacks.push(callback);
            }

            triggerUpdate() {
                if (this.currentTransactions && this.currentMembers) {
                    this.callbacks.forEach(callback => callback(this.currentTransactions, this.currentMembers));
                }
            }
            
            async addTransaction(transaction) {
                const docRef = await addDoc(this.transactionsCollection, {
                    ...transaction,
                    date: new Date(transaction.date)
                });
                return docRef.id;
            }

            async deleteTransaction(id) {
                const docRef = doc(this.transactionsCollection, id);
                await deleteDoc(docRef);
            }

            async addMember(name) {
                // Checa se já existe um membro com o mesmo nome para evitar duplicatas
                const membersQuery = await getDocs(query(this.membersCollection, where("name", "==", name.toUpperCase())));
                if (membersQuery.empty) {
                    const docRef = await addDoc(this.membersCollection, { name: name.toUpperCase(), rcc: {}, caixaExtra: {} });
                    return docRef.id;
                }
                return null;
            }
            
            async deleteMember(id) {
                const docRef = doc(this.membersCollection, id);
                await deleteDoc(docRef);
            }

            async updateMemberValue(memberId, type, yearMonth, value) {
                const docRef = doc(this.membersCollection, memberId);
                const memberDoc = await getDoc(docRef);
                if (memberDoc.exists()) {
                    const memberData = memberDoc.data();
                    const updatedField = {
                        [`${type}.${yearMonth}`]: parseFloat(value) || 0
                    };
                    await updateDoc(docRef, updatedField);
                }
            }

            getMonthlyData(year, transactions, members) {
                const data = [];
                const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                              'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

                for (let month = 1; month <= 12; month++) {
                    const monthTransactions = transactions.filter(t => {
                        const transactionDate = t.date.toDate();
                        return transactionDate.getFullYear() === year && transactionDate.getMonth() + 1 === month;
                    });
                    
                    const totalEntradas = monthTransactions.filter(t => t.type === 'entrada').reduce((sum, t) => sum + t.amount, 0);
                    const totalSaidas = monthTransactions.filter(t => t.type === 'saida').reduce((sum, t) => sum + t.amount, 0);
                    
                    const yearMonth = `${year}-${month}`;
                    const totalRcc = members.reduce((sum, member) => sum + (member.rcc[yearMonth] || 0), 0);
                    const totalCaixaExtra = members.reduce((sum, member) => sum + (member.caixaExtra[yearMonth] || 0), 0);
                    
                    const balance = (totalEntradas + totalRcc) - totalSaidas;
                    
                    data.push({
                        month,
                        year,
                        monthName: months[month - 1],
                        totalEntradas,
                        totalSaidas,
                        totalRcc,
                        totalCaixaExtra,
                        balance
                    });
                }
                
                return data;
            }
        }

        class NavigationManager {
            constructor(dataManager) {
                this.dataManager = dataManager;
                this.currentSection = 'home';
                this.init();
            }

            init() {
                // Event listeners para navegação
                document.getElementById('homeLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showSection('home');
                });

                document.querySelectorAll('.sidebar-menu-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const section = link.dataset.section;
                        this.showSection(section);
                    });
                });

                // Toggle sidebar
                document.getElementById('sidebarToggle').addEventListener('click', () => {
                    document.getElementById('sidebar').classList.toggle('collapsed');
                });

                document.getElementById('mobileSidebarToggle').addEventListener('click', () => {
                    document.getElementById('sidebar').classList.toggle('open');
                });
            }

            showSection(sectionName) {
                // Esconder todas as seções
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });

                // Mostrar seção ativa
                document.getElementById(sectionName).classList.add('active');

                // Atualizar navegação
                document.querySelectorAll('.sidebar-menu-link').forEach(link => {
                    link.classList.remove('active');
                });

                if (sectionName === 'home') {
                    document.querySelector(`[data-section="home"]`).classList.add('active');
                } else {
                    document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');
                }
                
                // Fechar sidebar no mobile
                document.getElementById('sidebar').classList.remove('open');
                
                this.currentSection = sectionName;
                this.dataManager.triggerUpdate(); // Força a atualização da seção
            }

            updateSectionData(transactions, members) {
                switch (this.currentSection) {
                    case 'home':
                        this.updateHomeData(transactions, members);
                        break;
                    case 'tesouraria':
                        this.updateTesourariaData(transactions, members);
                        break;
                    case 'membros':
                        this.updateMembrosData(transactions, members);
                        break;
                    case 'contabilidade':
                        this.updateContabilidadeData(transactions, members);
                        break;
                }
            }

            updateHomeData(transactions, members) {
                const totalEntradas = transactions.filter(t => t.type === 'entrada').reduce((sum, t) => sum + t.amount, 0);
                const totalSaidas = transactions.filter(t => t.type === 'saida').reduce((sum, t) => sum + t.amount, 0);
                const saldoAtual = totalEntradas - totalSaidas;

                const totalRccGeral = members.reduce((sum, member) => {
                    return sum + Object.values(member.rcc).reduce((memberSum, value) => memberSum + value, 0);
                }, 0);

                const totalCaixaExtraGeral = members.reduce((sum, member) => {
                    return sum + Object.values(member.caixaExtra).reduce((memberSum, value) => memberSum + value, 0);
                }, 0);

                document.getElementById('homeSaldoAtual').textContent = formatCurrency(saldoAtual);
                document.getElementById('homeTotalMembros').textContent = members.length;
                document.getElementById('homeTotalRcc').textContent = formatCurrency(totalRccGeral);
                document.getElementById('homeTotalCaixaExtra').textContent = formatCurrency(totalCaixaExtraGeral);

                // Atividades recentes
                const recentTransactions = transactions.slice(0, 5);
                const recentActivitiesElement = document.getElementById('recentActivities');

                if (recentTransactions.length === 0) {
                    recentActivitiesElement.innerHTML = '<p class="text-center text-muted py-8">Nenhuma atividade registrada ainda</p>';
                } else {
                    recentActivitiesElement.innerHTML = recentTransactions.map(transaction => `
                        <div class="flex justify-between items-center p-3 rounded border" style="border-color: hsl(0 0% 90%); margin-bottom: 12px;">
                            <div class="flex items-center gap-3">
                                <div class="w-2 h-2 rounded-full" style="background: ${transaction.type === 'entrada' ? '#22c55e' : '#ef4444'};"></div>
                                <div>
                                    <p class="font-medium" style="font-size: 14px;">${transaction.description}</p>
                                    <p class="text-muted" style="font-size: 12px;">${formatDate(transaction.date)}</p>
                                </div>
                            </div>
                            <div class="font-bold ${transaction.type === 'entrada' ? 'text-green-600' : 'text-red-600'}">
                                ${transaction.type === 'entrada' ? '+' : '-'}${formatCurrency(transaction.amount)}
                            </div>
                        </div>
                    `).join('');
                }
            }

            updateTesourariaData(transactions, members) {
                const totalEntradas = transactions.filter(t => t.type === 'entrada').reduce((sum, t) => sum + t.amount, 0);
                const totalSaidas = transactions.filter(t => t.type === 'saida').reduce((sum, t) => sum + t.amount, 0);
                const saldo = totalEntradas - totalSaidas;

                document.getElementById('totalEntradas').textContent = formatCurrency(totalEntradas);
                document.getElementById('totalSaidas').textContent = formatCurrency(totalSaidas);
                document.getElementById('saldoAtual').textContent = formatCurrency(saldo);
                document.getElementById('saldoAtual').className = `text-2xl font-bold ${saldo >= 0 ? 'text-green-600' : 'text-red-600'}`;

                // Histórico
                const historyElement = document.getElementById('transactionHistory');
                const recentTransactions = transactions.slice(0, 10);

                if (recentTransactions.length === 0) {
                    historyElement.innerHTML = '<p class="text-center text-muted py-8">Nenhuma transação registrada ainda</p>';
                } else {
                    historyElement.innerHTML = recentTransactions.map(transaction => `
                        <div class="flex justify-between items-start p-3 rounded border" style="border-color: hsl(0 0% 90%); margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <div class="flex items-center gap-2 mb-1">
                                    <i class="fas fa-${transaction.type === 'entrada' ? 'trending-up' : 'trending-down'} ${transaction.type === 'entrada' ? 'text-green-600' : 'text-red-600'}" style="font-size: 14px;"></i>
                                    <span class="font-medium" style="text-transform: capitalize;">${transaction.type}</span>
                                </div>
                                <p class="text-muted" style="font-size: 14px;">${transaction.description}</p>
                                <p class="text-muted" style="font-size: 12px;">
                                    ${formatDate(transaction.date)}
                                </p>
                            </div>
                            <div class="font-bold ${transaction.type === 'entrada' ? 'text-green-600' : 'text-red-600'}">
                                ${transaction.type === 'entrada' ? '+' : '-'}${formatCurrency(transaction.amount)}
                            </div>
                        </div>
                    `).join('');
                }
                
                // Popula o select de membros
                const memberSelect = document.getElementById('memberSelect');
                memberSelect.innerHTML = `<option value="">Nenhum</option>`;
                members.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name;
                    memberSelect.appendChild(option);
                });
            }

            updateMembrosData(transactions, members) {
                const selectedMonth = parseInt(document.getElementById('membersMonth').value);
                const selectedYear = parseInt(document.getElementById('membersYear').value);
                const yearMonth = `${selectedYear}-${selectedMonth}`;

                const totalRcc = members.reduce((sum, member) => sum + (member.rcc[yearMonth] || 0), 0);
                const totalCaixaExtra = members.reduce((sum, member) => sum + (member.caixaExtra[yearMonth] || 0), 0);

                document.getElementById('totalMembrosCount').textContent = members.length;
                document.getElementById('totalRccMes').textContent = formatCurrency(totalRcc);
                document.getElementById('totalCaixaExtraMes').textContent = formatCurrency(totalCaixaExtra);
                document.getElementById('currentMonthYear').textContent = `${this.getMonthName(selectedMonth)} ${selectedYear}`;

                // Tabela de membros
                const membersTableElement = document.getElementById('membersTable');

                if (members.length === 0) {
                    membersTableElement.innerHTML = '<p class="text-center text-muted py-8">Nenhum membro cadastrado</p>';
                } else {
                    const membersTableHTML = `
                        <div class="member-grid header">
                            <div>Nome</div>
                            <div class="text-center">RCC (R$)</div>
                            <div class="text-center">Caixa Extra (R$)</div>
                            <div class="text-center">Ações</div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            ${members.map(member => `
                                <div class="member-grid" style="align-items: center;">
                                    <div class="font-medium name" style="font-size: 14px;">${member.name}</div>
                                    <div>
                                        <input type="number" step="0.01" value="${member.rcc[yearMonth] || 0}"
                                               class="form-input text-center" style="height: 32px;"
                                               onchange="app.updateMemberValue('${member.id}', 'rcc', '${yearMonth}', this.value)">
                                    </div>
                                    <div>
                                        <input type="number" step="0.01" value="${member.caixaExtra[yearMonth] || 0}"
                                               class="form-input text-center" style="height: 32px;"
                                               onchange="app.updateMemberValue('${member.id}', 'caixaExtra', '${yearMonth}', this.value)">
                                    </div>
                                    <div class="flex justify-center actions">
                                        <button class="btn btn-sm text-red-600" style="background: none; padding: 4px 8px;"
                                                onclick="app.confirmRemoveMember('${member.id}', '${member.name}')">
                                            <i class="fas fa-trash" style="font-size: 14px;"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    membersTableElement.innerHTML = membersTableHTML;
                }
            }

            updateContabilidadeData(transactions, members) {
                const selectedYear = parseInt(document.getElementById('contabilidadeYear').value);
                document.getElementById('reportYear').textContent = selectedYear;

                const monthlyData = this.dataManager.getMonthlyData(selectedYear, transactions, members);
                const yearlyTotals = monthlyData.reduce((acc, month) => ({
                    totalEntradas: acc.totalEntradas + month.totalEntradas,
                    totalSaidas: acc.totalSaidas + month.totalSaidas,
                    totalRcc: acc.totalRcc + month.totalRcc,
                    totalCaixaExtra: acc.totalCaixaExtra + month.totalCaixaExtra,
                    balance: acc.balance + month.balance
                }), {
                    totalEntradas: 0,
                    totalSaidas: 0,
                    totalRcc: 0,
                    totalCaixaExtra: 0,
                    balance: 0
                });

                document.getElementById('yearlyEntradas').textContent = formatCurrency(yearlyTotals.totalEntradas);
                document.getElementById('yearlyRcc').textContent = formatCurrency(yearlyTotals.totalRcc);
                document.getElementById('yearlyCaixaExtra').textContent = formatCurrency(yearlyTotals.totalCaixaExtra);
                document.getElementById('yearlySaidas').textContent = formatCurrency(yearlyTotals.totalSaidas);
                document.getElementById('yearlyBalance').textContent = formatCurrency(yearlyTotals.balance);
                document.getElementById('yearlyBalance').className = `text-xl font-bold ${yearlyTotals.balance >= 0 ? 'text-green-600' : 'text-red-600'}`;

                // Relatório mensal
                const monthlyReportElement = document.getElementById('monthlyReport');
                const monthsWithData = monthlyData.filter(month =>
                    month.totalEntradas > 0 || month.totalSaidas > 0 || month.totalRcc > 0 || month.totalCaixaExtra > 0
                );

                if (monthsWithData.length === 0) {
                    monthlyReportElement.innerHTML = `
                        <div class="empty-state text-center py-10">
                            <i class="fas fa-chart-bar text-5xl text-muted mb-4"></i>
                            <p class="text-lg font-medium text-muted mb-2">Nenhum dado encontrado para ${selectedYear}</p>
                            <p class="text-muted text-sm">Registre transações e contribuições dos membros para ver os relatórios aqui.</p>
                        </div>
                    `;
                } else {
                    const reportHTML = `
                        <div class="grid monthly-report-grid gap-4 p-3 rounded-lg border bg-bg-light font-semibold text-sm mb-4">
                            <div>Mês</div>
                            <div class="text-center">Entradas</div>
                            <div class="text-center">Saídas</div>
                            <div class="text-center">RCC</div>
                            <div class="text-center">Caixa Extra</div>
                            <div class="text-center">Saldo</div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            ${monthsWithData.map(data => `
                                <div class="grid monthly-report-grid gap-4 p-3 rounded-lg border bg-white items-center">
                                    <div class="font-medium text-sm">${data.monthName}</div>
                                    <div class="text-center text-green-600 font-medium">${formatCurrency(data.totalEntradas)}</div>
                                    <div class="text-center text-red-600 font-medium">${formatCurrency(data.totalSaidas)}</div>
                                    <div class="text-center text-blue-600 font-medium">${formatCurrency(data.totalRcc)}</div>
                                    <div class="text-center text-blue-600 font-medium">${formatCurrency(data.totalCaixaExtra)}</div>
                                    <div class="text-center font-bold ${data.balance >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(data.balance)}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    monthlyReportElement.innerHTML = reportHTML;
                }
            }
            
            getMonthName(monthNumber) {
                const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                              'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                return months[monthNumber - 1];
            }
        }

        class FinanceApp {
            constructor() {
                this.dataManager = new DataManager();
                this.navigationManager = new NavigationManager(this.dataManager);
                this.init();
            }

            init() {
                this.setupYearSelectors();
                this.setupForms();
                this.setupModal();
                this.setCurrentDate();
                this.dataManager.addCallback(this.updateUI.bind(this));
                
                // Expor funções globais para o HTML
                window.app = {
                    updateMemberValue: this.updateMemberValue.bind(this),
                    confirmRemoveMember: this.confirmRemoveMember.bind(this)
                };
            }

            updateUI(transactions, members) {
                this.navigationManager.updateSectionData(transactions, members);
            }

            setupYearSelectors() {
                const years = Array.from({ length: 26 }, (_, i) => 2025 + i);
                const currentYear = new Date().getFullYear();
                const currentMonth = new Date().getMonth() + 1;

                const months = [
                    { value: 1, name: 'Jan' }, { value: 2, name: 'Fev' }, { value: 3, name: 'Mar' },
                    { value: 4, name: 'Abr' }, { value: 5, name: 'Mai' }, { value: 6, name: 'Jun' },
                    { value: 7, name: 'Jul' }, { value: 8, name: 'Ago' }, { value: 9, name: 'Set' },
                    { value: 10, name: 'Out' }, { value: 11, name: 'Nov' }, { value: 12, name: 'Dez' }
                ];
                
                const monthSelector = document.getElementById('membersMonth');
                monthSelector.innerHTML = months.map(m => `<option value="${m.value}">${m.name}</option>`).join('');
                monthSelector.value = currentMonth;

                const yearSelectors = ['membersYear', 'contabilidadeYear'];
                yearSelectors.forEach(selectorId => {
                    const selector = document.getElementById(selectorId);
                    selector.innerHTML = years.map(year =>
                        `<option value="${year}" ${year === currentYear ? 'selected' : ''}>${year}</option>`
                    ).join('');
                });
            }

            setupForms() {
                // Formulário de transação
                document.getElementById('transactionForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleTransactionForm();
                });

                // Formulário de membro
                document.getElementById('memberForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleMemberForm();
                });

                // Event listeners para mudança de mês/ano em membros
                document.getElementById('membersMonth').addEventListener('change', () => {
                    this.updateUI(this.dataManager.currentTransactions, this.dataManager.currentMembers);
                });

                document.getElementById('membersYear').addEventListener('change', () => {
                    this.updateUI(this.dataManager.currentTransactions, this.dataManager.currentMembers);
                });

                // Event listener para mudança de ano em contabilidade
                document.getElementById('contabilidadeYear').addEventListener('change', () => {
                    this.updateUI(this.dataManager.currentTransactions, this.dataManager.currentMembers);
                });
            }

            setupModal() {
                this.memberToRemove = null;

                document.getElementById('cancelBtn').addEventListener('click', () => {
                    document.getElementById('confirmModal').classList.remove('open');
                });

                document.getElementById('confirmBtn').addEventListener('click', async () => {
                    if (this.memberToRemove) {
                        await this.dataManager.deleteMember(this.memberToRemove.id);
                        this.showToast(`${this.memberToRemove.name} foi removido da lista`, 'success');
                    }
                    document.getElementById('confirmModal').classList.remove('open');
                });
            }

            setCurrentDate() {
                const now = new Date();
                const currentDate = now.toISOString().split('T')[0];
                document.getElementById('transactionDate').value = currentDate;
            }

            async handleTransactionForm() {
                const form = document.getElementById('transactionForm');
                const type = document.getElementById('transactionType').value;
                const description = document.getElementById('transactionDescription').value;
                const amount = parseFloat(document.getElementById('transactionAmount').value);
                const date = document.getElementById('transactionDate').value;
                const memberId = document.getElementById('memberSelect').value || null;

                if (!description || !amount || isNaN(amount)) {
                    this.showToast('Preencha todos os campos obrigatórios', 'error');
                    return;
                }

                await this.dataManager.addTransaction({
                    type,
                    description,
                    amount,
                    date,
                    member: memberId
                });

                this.showToast(`${type === 'entrada' ? 'Entrada' : 'Saída'} registrada com sucesso!`);
                form.reset();
                this.setCurrentDate();
            }

            async handleMemberForm() {
                const name = document.getElementById('memberName').value.trim();

                if (!name) {
                    this.showToast('Digite o nome do membro', 'error');
                    return;
                }

                const memberId = await this.dataManager.addMember(name);
                
                if (memberId) {
                    this.showToast('Membro adicionado com sucesso!');
                    document.getElementById('memberName').value = '';
                } else {
                    this.showToast('Já existe um membro com este nome', 'error');
                }
            }

            updateMemberValue(memberId, type, yearMonth, value) {
                this.dataManager.updateMemberValue(memberId, type, yearMonth, value);
            }

            confirmRemoveMember(memberId, memberName) {
                this.memberToRemove = { id: memberId, name: memberName };
                document.getElementById('confirmText').innerHTML =
                    `Tem certeza que deseja remover <strong>${memberName}</strong> da lista de membros?
                     Esta ação é permanente.`;
                document.getElementById('confirmModal').classList.add('open');
            }

            showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${type === 'error' ? 'toast-error' : ''}`;
                toast.textContent = message;

                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }, 3000);
            }
        }

        // Inicializar aplicação
        const app = new FinanceApp();
    </script>

</body>
</html>
