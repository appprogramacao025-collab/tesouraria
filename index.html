<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grupo de Oração Nossa Senhora das Graças - Controle Financeiro</title>
  <meta name="description" content="Sistema de controle financeiro para o Grupo de Oração Nossa Senhora das Graças">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* CSS original do projeto (omitido aqui por brevidade, mas mantido no seu arquivo final) */
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar e conteúdo original mantidos -->
    <!-- ... -->
  </div>

  <!-- Modal para confirmar remoção de membro -->
  <div class="modal" id="confirmModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Remover Membro</h3>
      </div>
      <div class="modal-body">
        <p id="confirmText"></p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelBtn">Cancelar</button>
        <button class="btn btn-danger" id="confirmBtn">Remover</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>

  <script>
    // Configuração do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA4ojfhf2r65ch0KwtCLR4OGdesBBVl7Ok",
      authDomain: "tesouraria-17927.firebaseapp.com",
      projectId: "tesouraria-17927",
      storageBucket: "tesouraria-17927.firebasestorage.app",
      messagingSenderId: "618185390033",
      appId: "1:618185390033:web:53b6f976ca66f48edd52f0",
      measurementId: "G-NM7X5BJBN7"
    };

    // Inicializar Firebase
    const appFirebase = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // DataManager com Firestore
    class DataManager {
      constructor() {
        this.transactions = [];
        this.members = [];
      }

      async loadTransactions() {
        const snapshot = await db.collection("transactions").get();
        this.transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        return this.transactions;
      }

      async loadMembers() {
        const snapshot = await db.collection("members").get();
        this.members = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        return this.members;
      }

      async addTransaction(transaction) {
        const docRef = await db.collection("transactions").add(transaction);
        const newTransaction = { id: docRef.id, ...transaction };
        this.transactions.push(newTransaction);
        return newTransaction;
      }

      async addMember(name) {
        const newMember = {
          name: name.toUpperCase(),
          rcc: {},
          caixaExtra: {}
        };
        const docRef = await db.collection("members").add(newMember);
        newMember.id = docRef.id;
        this.members.push(newMember);
        return newMember;
      }

      async removeMember(id) {
        await db.collection("members").doc(id).delete();
        this.members = this.members.filter(m => m.id !== id);
      }

      async updateMemberValue(memberId, type, yearMonth, value) {
        const memberRef = db.collection("members").doc(memberId);
        const member = this.members.find(m => m.id === memberId);
        if (member) {
          member[type][yearMonth] = value;
          await memberRef.update({ [type]: member[type] });
        }
      }
    }

    // NavigationManager e restante do FinanceApp (mesmo do arquivo original),
    // apenas ajustando para async/await onde necessário.

    class FinanceApp {
      constructor() {
        this.dataManager = new DataManager();
        this.navigationManager = new NavigationManager(this.dataManager);
        this.init();
      }

      async init() {
        await this.dataManager.loadTransactions();
        await this.dataManager.loadMembers();
        this.setupYearSelectors();
        this.setupForms();
        this.setupModal();
        this.setCurrentDate();
        this.navigationManager.updateHomeData();
      }

      async handleTransactionForm() {
        const type = document.getElementById('transactionType').value;
        const description = document.getElementById('transactionDescription').value;
        const amount = parseFloat(document.getElementById('transactionAmount').value);
        const month = parseInt(document.getElementById('transactionMonth').value);
        const year = parseInt(document.getElementById('transactionYear').value);
        const date = document.getElementById('transactionDate').value;

        if (!description || !amount) {
          this.showToast('Preencha todos os campos obrigatórios', 'error');
          return;
        }

        await this.dataManager.addTransaction({ type, description, amount, month, year, date });
        this.showToast(`${type === 'entrada' ? 'Entrada' : 'Saída'} registrada com sucesso!`, 'success');

        document.getElementById('transactionDescription').value = '';
        document.getElementById('transactionAmount').value = '';

        this.navigationManager.updateTesourariaData();
        this.navigationManager.updateHomeData();
      }

      async handleMemberForm() {
        const name = document.getElementById('memberName').value.trim();
        if (!name) {
          this.showToast('Digite o nome do membro', 'error');
          return;
        }
        if (this.dataManager.members.some(m => m.name.toLowerCase() === name.toLowerCase())) {
          this.showToast('Já existe um membro com este nome', 'error');
          return;
        }
        await this.dataManager.addMember(name);
        this.showToast('Membro adicionado com sucesso!', 'success');
        document.getElementById('memberName').value = '';
        this.navigationManager.updateMembrosData();
        this.navigationManager.updateHomeData();
      }

      async updateMemberValue(memberId, type, yearMonth, value) {
        const numValue = parseFloat(value) || 0;
        await this.dataManager.updateMemberValue(memberId, type, yearMonth, numValue);
        this.navigationManager.updateMembrosData();
        this.navigationManager.updateHomeData();
      }

      async confirmRemoveMember(memberId, memberName) {
        this.memberToRemove = { id: memberId, name: memberName };
        document.getElementById('confirmText').innerHTML =
          `Tem certeza que deseja remover <strong>${memberName}</strong> da lista de membros? 
           Esta ação não pode ser desfeita e todos os dados históricos serão perdidos.`;
        document.getElementById('confirmModal').classList.add('open');

        document.getElementById('confirmBtn').onclick = async () => {
          await this.dataManager.removeMember(memberId);
          this.showToast(`${memberName} foi removido da lista`, 'success');
          this.navigationManager.updateMembrosData();
          this.navigationManager.updateHomeData();
          document.getElementById('confirmModal').classList.remove('open');
        };
      }

      // showToast, setupYearSelectors etc. mantidos do arquivo original
    }

    const app = new FinanceApp();
    window.app = app;
  </script>
</body>
</html>
